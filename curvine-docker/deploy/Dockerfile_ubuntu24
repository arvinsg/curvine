# Build stage
FROM ubuntu:24.04 AS builder

# Add metadata labels
ARG REPO_URL=https://github.com/curvineio/curvine
LABEL org.opencontainers.image.source="${REPO_URL}"
LABEL org.opencontainers.image.description="Curvine Native Kubernetes Runtime Image"

# Set non-interactive mode for apt to avoid prompts during install
ENV DEBIAN_FRONTEND=noninteractive

# Use Alibaba Cloud mirror for faster package downloads in China
RUN mv /etc/apt/sources.list.d/ubuntu.sources /etc/apt/sources.list.d/ubuntu.sources.backup 2>/dev/null || true && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse' > /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble-backports main restricted universe multiverse' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble-security main restricted universe multiverse' >> /etc/apt/sources.list && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# 1. Install the basic toolchain and dependencies
RUN apt-get update && apt-get install -y --fix-missing \
    fuse3 \
    libfuse3-dev \
    clang \
    llvm \
    llvm-dev \
    git \
    wget \
    curl \
    zip \
    unzip \
    nodejs \
    npm \
    openjdk-8-jdk \
    libssl-dev \
    pkg-config \
    ca-certificates \
    rsync \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 2. Install the Rust toolchain
RUN export PATH="/root/.cargo/bin:${PATH}" && \
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable && \
    . $HOME/.cargo/env && \
    rustup default stable && \
    rustup component add rustfmt clippy

# 3. Install protoc
RUN mkdir -p /app/protoc && cd /app/protoc && \
    curl -k -LO https://github.com/protocolbuffers/protobuf/releases/download/v27.2/protoc-27.2-linux-x86_64.zip && \
    unzip protoc-27.2-linux-x86_64.zip && \
    chmod +x bin/protoc && \
    rm -f *.zip

# 4. Install JindoSDK (for OSS-HDFS support) with multi-arch support
RUN cd /opt && \
    JINDOSDK_VERSION=6.10.3 && \
    ARCH=$(uname -m) && \
    echo "Installing JindoSDK ${JINDOSDK_VERSION} for ${ARCH}..." && \
    case "${ARCH}" in \
        x86_64) \
            JINDOSDK_FILE="jindosdk-${JINDOSDK_VERSION}-linux.tar.gz" ;; \
        aarch64) \
            JINDOSDK_FILE="jindosdk-${JINDOSDK_VERSION}-linux-el7-aarch64.tar.gz" ;; \
        *) \
            echo "Unsupported architecture: ${ARCH}" && exit 1 ;; \
    esac && \
    echo "Downloading ${JINDOSDK_FILE}..." && \
    curl -fL -o ${JINDOSDK_FILE} \
        https://jindodata-binary.oss-cn-shanghai.aliyuncs.com/release/${JINDOSDK_VERSION}/${JINDOSDK_FILE} && \
    tar -xzf ${JINDOSDK_FILE} && \
    EXTRACTED_DIR=$(ls -d jindosdk* | head -n1) && \
    if [ "$EXTRACTED_DIR" != "jindosdk" ]; then \
        mv "$EXTRACTED_DIR" jindosdk; \
    fi && \
    rm -f ${JINDOSDK_FILE} && \
    echo "✓ JindoSDK ${JINDOSDK_VERSION} installed successfully for ${ARCH}"

ENV JINDOSDK_HOME=/opt/jindosdk
ENV LD_LIBRARY_PATH="${JINDOSDK_HOME}/lib/native:${JINDOSDK_HOME}/lib"

# 5. Copy and apply build configurations
COPY curvine-docker/deploy/config /build-config/config
RUN mkdir -p /root/.cargo && \
    cp /build-config/config /root/.cargo/config.toml

# Set environment variables for build
ENV PATH="/root/.cargo/bin:/app/protoc/bin:${PATH}"
# Set JAVA_HOME for HDFS JNI compilation (multi-arch support)
RUN ARCH=$(uname -m) && \
    case "${ARCH}" in \
        x86_64) JAVA_HOME_VALUE="/usr/lib/jvm/java-8-openjdk-amd64" ;; \
        aarch64) \
            if [ -d "/usr/lib/jvm/java-8-openjdk-arm64" ]; then \
                JAVA_HOME_VALUE="/usr/lib/jvm/java-8-openjdk-arm64"; \
            elif [ -d "/usr/lib/jvm/java-8-openjdk-aarch64" ]; then \
                JAVA_HOME_VALUE="/usr/lib/jvm/java-8-openjdk-aarch64"; \
            else \
                JAVA_HOME_VALUE="/usr/lib/jvm/java-8-openjdk-amd64"; \
            fi ;; \
        *) JAVA_HOME_VALUE="/usr/lib/jvm/java-8-openjdk-amd64" ;; \
    esac && \
    echo "export JAVA_HOME=${JAVA_HOME_VALUE}" >> /etc/profile && \
    if [ -d "$JAVA_HOME_VALUE/include" ] && [ ! -d "$JAVA_HOME_VALUE/jre/include" ]; then \
        mkdir -p "$JAVA_HOME_VALUE/jre" && \
        ln -s ../include "$JAVA_HOME_VALUE/jre/include"; \
    fi

ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

# Copy and build source code if building from source
COPY . /workspace/
WORKDIR /workspace

# 6. Update JAVA_HOME at runtime for current architecture
RUN ARCH=$(uname -m) && \
    case "${ARCH}" in \
        x86_64) export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64" ;; \
        aarch64) \
            if [ -d "/usr/lib/jvm/java-8-openjdk-arm64" ]; then \
                export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-arm64"; \
            elif [ -d "/usr/lib/jvm/java-8-openjdk-aarch64" ]; then \
                export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-aarch64"; \
            fi ;; \
    esac && \
    echo "JAVA_HOME set to: ${JAVA_HOME}"

# 7. Pre-install WebUI dependencies and fix vue-cli-service module resolution
RUN if [ -d "/workspace/curvine-web/webui" ]; then \
        echo "Pre-installing WebUI dependencies..."; \
        cd /workspace/curvine-web/webui && \
        npm install --legacy-peer-deps && \
        echo "npm install completed" && \
        # Fix: vue-cli-service wrapper script expects node_modules/package.json
        # Create symlink to @vue/cli-service/package.json
        ln -s @vue/cli-service/package.json node_modules/package.json && \
        echo "Created symlink: node_modules/package.json -> @vue/cli-service/package.json" && \
        ls -la node_modules/package.json; \
    fi

# 8. Patch build.sh to use direct vue-cli-service.js call
RUN if [ -f "/workspace/build/build.sh" ]; then \
        echo "Patching build.sh to fix vue-cli-service wrapper script issue..."; \
        sed -i 's/npm run build/node node_modules\/@vue\/cli-service\/bin\/vue-cli-service.js build/g' /workspace/build/build.sh && \
        echo "Patch applied" && \
        grep -n "vue-cli-service" /workspace/build/build.sh || true; \
    fi

# 9. Build the project from source with all UFS support
RUN echo "Building Curvine from source..." && \
    # Set JAVA_HOME for current architecture
    ARCH=$(uname -m) && \
    case "${ARCH}" in \
        x86_64) export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64" ;; \
        aarch64) \
            if [ -d "/usr/lib/jvm/java-8-openjdk-arm64" ]; then \
                export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-arm64"; \
            elif [ -d "/usr/lib/jvm/java-8-openjdk-aarch64" ]; then \
                export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-aarch64"; \
            else \
                export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64"; \
            fi ;; \
        *) export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64" ;; \
    esac && \
    echo "Using JAVA_HOME: ${JAVA_HOME} for HDFS JNI compilation" && \
    export CURVINE_HOME=/workspace && \
    mkdir -p /workspace/tmp && \
    export TMPDIR=/workspace/tmp && \
    echo "Using TMPDIR=$TMPDIR for compilation temporary files" && \
    echo "Running 'make all' with --skip-java-sdk and all UFS support..." && \
    # Build with retry mechanism and all UFS support
    for attempt in 1 2 3; do \
        echo "Build attempt $attempt..." && \
        if make all ARGS='--skip-java-sdk --ufs opendal-s3 --ufs opendal-oss --ufs opendal-azblob --ufs opendal-gcs --ufs opendal-hdfs --ufs opendal-webhdfs --ufs oss-hdfs'; then \
            echo "✓ Build succeeded with all UFS support" && \
            break; \
        else \
            echo "✗ Build attempt $attempt failed" && \
            if [ $attempt -eq 3 ]; then \
                echo "✗ All build attempts failed" && \
                exit 1; \
            fi && \
            echo "Retrying... (attempt $((attempt + 1))/3)" && \
            sleep 10; \
        fi; \
    done && \
    if [ ! -d "/workspace/build/dist" ]; then \
        echo "✗ ERROR: /workspace/build/dist not found after build" && \
        exit 1; \
    fi && \
    # Clean up temporary files to reduce image size
    rm -rf /workspace/tmp

# 10. Create output directory and copy build artifacts from build/dist
RUN mkdir -p /build-output && \
    echo "Copying build/dist contents to /build-output..." && \
    cp -r /workspace/build/dist/* /build-output/ && \
    # Verify critical files exist
    if [ ! -f "/build-output/bin/launch-process.sh" ]; then \
        echo "✗ ERROR: launch-process.sh not found in build/dist/bin" && \
        exit 1; \
    fi && \
    if [ ! -f "/build-output/lib/curvine-server" ]; then \
        echo "✗ ERROR: curvine-server not found in build/dist/lib" && \
        exit 1; \
    fi && \
    echo "Build output summary:" && \
    echo "  bin/: $(ls -1 /build-output/bin 2>/dev/null | wc -l) files" && \
    echo "  lib/: $(ls -1 /build-output/lib 2>/dev/null | wc -l) files" && \
    echo "  conf/: $(ls -1 /build-output/conf 2>/dev/null | wc -l) files"

# Runtime stage
FROM ubuntu:24.04

# Set non-interactive mode for apt
ENV DEBIAN_FRONTEND=noninteractive

# Use Alibaba Cloud mirror for faster package downloads in China
RUN mv /etc/apt/sources.list.d/ubuntu.sources /etc/apt/sources.list.d/ubuntu.sources.backup 2>/dev/null || true && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse' > /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble-backports main restricted universe multiverse' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/ubuntu/ noble-security main restricted universe multiverse' >> /etc/apt/sources.list && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install runtime dependencies (minimal set)
RUN apt-get update && apt-get install -y --no-install-recommends \
    fuse3 \
    libfuse3-3 \
    procps \
    openjdk-8-jre-headless \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/cache/apt/*

# Copy JindoSDK from builder stage for OSS-HDFS support
COPY --from=builder /opt/jindosdk /opt/jindosdk

ENV JINDOSDK_HOME=/opt/jindosdk
ENV LD_LIBRARY_PATH="${JINDOSDK_HOME}/lib/native:${JINDOSDK_HOME}/lib"

# Create curvine directories
RUN mkdir -p /app/curvine \
    && mkdir -p /opt/curvine/data/{meta,journal} \
    && mkdir -p /opt/curvine/logs

# Always create the base directory structure
RUN mkdir -p /app/curvine/bin /app/curvine/lib /app/curvine/conf

# Copy from builder stage when building from source
COPY --from=builder /build-output/ /app/curvine/

# Copy entrypoint script (use compile-specific entrypoint)
COPY curvine-docker/deploy/entrypoint.sh /entrypoint.sh

# Make all binaries and scripts executable
RUN find /app/curvine -type f -name "*.sh" -exec chmod +x {} \; \
    && find /app/curvine -type f -path "*/bin/*" -exec chmod +x {} \; \
    && find /app/curvine -type f -path "*/lib/*" -exec chmod +x {} \; \
    && chmod +x /entrypoint.sh

# Set environment variables
ENV APP_HOME=/app
ENV CURVINE_HOME=/app/curvine
ENV PATH=$PATH:$CURVINE_HOME/bin

# Override environment settings for container
ENV ORPC_BIND_HOSTNAME=0.0.0.0
ENV CURVINE_CONF_FILE=$CURVINE_HOME/conf/curvine-cluster.toml

WORKDIR $APP_HOME

# Expose ports
# 8995: Master RPC
# 8996: Master Journal/Raft
# 8997: Worker RPC
# 9000: Master Web UI
# 9001: Worker Web UI / Master Web1
EXPOSE 8995 8996 8997 9000 9001

ENTRYPOINT ["/entrypoint.sh"]
CMD ["master", "start"]

