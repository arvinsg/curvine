name: Build Compile Docker Image

on:
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Whether to push image to registries'
        required: false
        default: false
        type: boolean
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string

permissions:
  contents: read
  packages: write

jobs:
  # Build for each build type and architecture on native runners
  build-image:
    strategy:
      matrix:
        include:
          # Rocky Linux 9 (standard)
          - build_type: rocky9
            dockerfile: Dockerfile_rocky9
            context: ./curvine-docker/compile
            tag: rocky9
            arch: amd64
            runner: ubuntu-latest
          - build_type: rocky9
            dockerfile: Dockerfile_rocky9
            context: ./curvine-docker/compile
            tag: rocky9
            arch: arm64
            runner: ubuntu-24.04-arm
          # Rocky Linux 9 (cached)
          - build_type: rocky9_cached
            dockerfile: Dockerfile_rocky9_cached
            context: .
            tag: rocky9_cached
            arch: amd64
            runner: ubuntu-latest
          - build_type: rocky9_cached
            dockerfile: Dockerfile_rocky9_cached
            context: .
            tag: rocky9_cached
            arch: arm64
            runner: ubuntu-24.04-arm
          # Ubuntu 22.04
          - build_type: ubuntu22.04
            dockerfile: Dockerfile_ubuntu22
            context: ./curvine-docker/compile
            tag: ubuntu22.04
            arch: amd64
            runner: ubuntu-latest
          - build_type: ubuntu22.04
            dockerfile: Dockerfile_ubuntu22
            context: ./curvine-docker/compile
            tag: ubuntu22.04
            arch: arm64
            runner: ubuntu-24.04-arm
          # Ubuntu 24.04
          - build_type: ubuntu24.04
            dockerfile: Dockerfile_ubuntu24
            context: ./curvine-docker/compile
            tag: ubuntu24.04
            arch: amd64
            runner: ubuntu-latest
          - build_type: ubuntu24.04
            dockerfile: Dockerfile_ubuntu24
            context: ./curvine-docker/compile
            tag: ubuntu24.04
            arch: arm64
            runner: ubuntu-24.04-arm
          # Amazon Linux 2
          - build_type: amzn2
            dockerfile: Dockerfile_amzn2
            context: ./curvine-docker/compile
            tag: amzn2
            arch: amd64
            runner: ubuntu-latest
          - build_type: amzn2
            dockerfile: Dockerfile_amzn2
            context: ./curvine-docker/compile
            tag: amzn2
            arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        if: inputs.push_image == true
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.PAT_GITHUB_TOKEN }}
      
      - name: Login to Docker Hub
        if: inputs.push_image == true
        uses: docker/login-action@v3
        with:
          username: curvine
          password: ${{ secrets.PAT_DOCKERIO_TOKEN }}
      
      - name: Build and push compile image for ${{ matrix.build_type }} (${{ matrix.arch }})
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ./curvine-docker/compile/${{ matrix.dockerfile }}
          platforms: linux/${{ matrix.arch }}
          push: ${{ inputs.push_image }}
          tags: |
            ghcr.io/curvineio/curvine-compile:${{ matrix.tag }}-${{ matrix.arch }}
            curvine/curvine-compile:${{ matrix.tag }}-${{ matrix.arch }}
          cache-from: type=gha,scope=compile-${{ matrix.build_type }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=compile-${{ matrix.build_type }}-${{ matrix.arch }}
      
      - name: Build summary for ${{ matrix.build_type }} (${{ matrix.arch }})
        run: |
          echo "âœ… Built compile image for ${{ matrix.build_type }} (${{ matrix.arch }})" >> $GITHUB_STEP_SUMMARY
          echo "Image: ghcr.io/curvineio/curvine-compile:${{ matrix.tag }}-${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY

  # Create multi-arch manifests for each build type
  create-manifest:
    needs: build-image
    runs-on: ubuntu-latest
    if: inputs.push_image == true
    strategy:
      matrix:
        include:
          - tag: rocky9
          - tag: rocky9_cached
          - tag: ubuntu22.04
          - tag: ubuntu24.04
          - tag: amzn2
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.PAT_GITHUB_TOKEN }}
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: curvine
          password: ${{ secrets.PAT_DOCKERIO_TOKEN }}
      
      - name: Create and push multi-arch manifest for ${{ matrix.tag }}
        run: |
          # Create manifest for GHCR
          docker buildx imagetools create -t ghcr.io/curvineio/curvine-compile:${{ matrix.tag }} \
            ghcr.io/curvineio/curvine-compile:${{ matrix.tag }}-amd64 \
            ghcr.io/curvineio/curvine-compile:${{ matrix.tag }}-arm64
          
          # Create manifest for Docker Hub
          docker buildx imagetools create -t curvine/curvine-compile:${{ matrix.tag }} \
            curvine/curvine-compile:${{ matrix.tag }}-amd64 \
            curvine/curvine-compile:${{ matrix.tag }}-arm64
      
      - name: Manifest creation summary for ${{ matrix.tag }}
        run: |
          echo "### Multi-arch Manifest Created for ${{ matrix.tag }} ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ matrix.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Combined architectures:** amd64, arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manifests created:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/curvineio/curvine-compile:${{ matrix.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`curvine/curvine-compile:${{ matrix.tag }}\`" >> $GITHUB_STEP_SUMMARY

  # Final summary
  summary:
    needs: [build-image, create-manifest]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Final build summary
        run: |
          echo "### Compile Image Build Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Types:** rocky9, rocky9_cached, ubuntu22.04, ubuntu24.04, amzn2" >> $GITHUB_STEP_SUMMARY
          echo "**Architectures:** amd64 (native), arm64 (native)" >> $GITHUB_STEP_SUMMARY
          echo "**Build Strategy:** Native runners for each architecture" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** workflow_dispatch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.push_image }}" == "true" ]; then
            echo "**Multi-arch images pushed to:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/curvineio/curvine-compile:rocky9\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/curvineio/curvine-compile:rocky9_cached\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/curvineio/curvine-compile:ubuntu22.04\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/curvineio/curvine-compile:ubuntu24.04\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/curvineio/curvine-compile:amzn2\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pull commands:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Rocky Linux 9 (standard)" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/curvineio/curvine-compile:rocky9" >> $GITHUB_STEP_SUMMARY
            echo "# Rocky Linux 9 (cached)" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/curvineio/curvine-compile:rocky9_cached" >> $GITHUB_STEP_SUMMARY
            echo "# Ubuntu 22.04" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/curvineio/curvine-compile:ubuntu22.04" >> $GITHUB_STEP_SUMMARY
            echo "# Ubuntu 24.04" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/curvineio/curvine-compile:ubuntu24.04" >> $GITHUB_STEP_SUMMARY
            echo "# Amazon Linux 2" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/curvineio/curvine-compile:amzn2" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Verify multi-arch" >> $GITHUB_STEP_SUMMARY
            echo "docker buildx imagetools inspect ghcr.io/curvineio/curvine-compile:rocky9" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Note:** Images were built but not pushed (push_image=false)" >> $GITHUB_STEP_SUMMARY
          fi
